
## Additional notes 

### Hierarchical analysis of population structure 

We can group our isolates into hierarchical clusters.  

Phylogenetic trees are easily to interpret visually when they contain very few isolates. However, with larger isolates, or less well defined trees it is often much harder to define what isolates are contained in a 'cluster' or 'sub-cluster'. 
For this reason tools exist to cluster your isolates in an automated manner using a statistical framework. Sometime these tools will identify structure that was not obvious my visual interpretation. 

For hierarchical clustering we will use a tool called [BAPS](http://www.helsinki.fi/bsg/software/BAPS/) (Bayesian Analysis of Population Structure) and its associated tool Hierarchical BAPS/hierBAPS. This tool was developed here in Helsinki. 

```
# Make a directory for this analysis 
mkdir BAPS && cd BAPS

# copy your alignment into this folder.  
./hierBAPS.sh exData core_gene_alignment.fasta fasta  # This will produce an input file called "***.mat" from you alignment file.

./hierBAPS.sh hierBAPS seqs.mat 2 10 results_core > BAPS_log.txt  # This will launch hierBAPS. hierBAPS will save an output file named results.mat (binary format) and a partition file "results.partition.txt". It will go two levels deep into the heirachy and use a prior of 10 clusters. 

./hierBAPS.sh drawSnpMat results_core.mat shuffle # This will draw a SNP matrix with rows and columns shuffled as shown in BAPS 6.0 manual. Without the "shuffle" parameter, the columns will not be shuffled. Consecutive rows between horizontal black lines represent a 1st layer cluster.

grep ">" core_gene_alignment.fasta > temp.txt && sed 's/>//' temp.txt > labels.txt

```

We do not just have to visualise our BAPS clusters with the provided tool. We can also use a number of other tools. 

We can visualise our BAPS output a number of ways. Here we will use Phandango. 

Open results.partition.txt in Excel/Libreoffice. Add a column to the left hand side called taxa with the entries from labels.txt. Add column headers to columns 2-4 (BAPS Group 1-3). 
Add the metadata columns from metadata.tab. Save the file as BAPS_annotation.csv (ensure it is saved in csv format). 

Now we can drag and drop our tree file (ensure the file extension is .tre) and our BAPS cluster information (filename.csv) onto Phandango. 

This allows us to visualise the major clusters and any subclusters within these in an interactive manner. 

Now we can use our scroll wheel to zoom into any region on the figure. We can also subset out tree. More instructions are available at the appropriate tab at the top of the screen. 


### Identifying Recombination 

Recombination is a factor that can have a large impact on the inference of phylogeny from bacterial whole genome datasets. 
Large amounts of recombination between distantly related isolates can make them seem more genetically similar than if we were to look at them from the perspective of clonal decent. 

It is often prudent to identify and remove recombination/recombinant sites from our dataset so that the impact of recombination does not effect our inference of phylogeny. 

There are a number of tools available to identify recombinant sites within WGS data including ClonalFrame, ClonalFrameML, Gubbins and BratNextGen. 

Today we will be using BratNextGen which was developed here in Helsinki (By Jukka Corander and Co., the creator of BAPS). This will have been locally installed on your laptop.

Use the core genome alignment that was generated by Roary. 


```
bash run_bratNextGen.sh /PATH/TO/MCR_IN
 
File -> Load Data -> Select dataset (must have .aln suffix)

Draw PSA Tree -> Select a line that corresponds to BAPS Group 1 -> Get clustering and close

Learn Recombinations -> Choose number of iterations = 3 -> OK -> Wait 

# This represents a very low number of iterations. However, on the Renibacterium Salmoninarum dataset we have very few mutations and this should be suitable. 

Estimate significance -> Run Locally -> 20

# This will run the whole analysis 20 times to generate a p-value. Again, this is a very low value used for demonstration purposes. 

Results -> Draw Segments 

# Sections in-line with each other show 

Results -> Write Segments
```

The results of BratNextGen can be visualised in Phandango. Just drag and drop the output of BratNextGen to the Phandango window. 
